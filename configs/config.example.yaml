###############################################
# Example configuration file (config.yaml)
# -------------------------------------------------
# Objetivo: plantilla segura SIN credenciales reales.
# Renombrar a config.yaml y ajustar lo necesario.
# Cada clave puede sobre-escribirse con variables de entorno.
# Precedencia: defaults código < config.yaml < variables entorno < flags CLI.
#
# NO coloques aquí secretos productivos (SMTP password, Google client_secret, etc.).
# Usa variables de entorno para valores sensibles:
#   export SMTP_PASSWORD="..."
#   export GOOGLE_CLIENT_SECRET="..."
#
# Duraciones: formato Go (15m, 1h, 48h, 30s, 10m15s).
#
# SIGNING_MASTER_KEY (para cifrar secretos MFA y llaves privadas) NO va en este YAML.
# Debe exportarse por ENV (64 hex/32 bytes recomendado):
#   export SIGNING_MASTER_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
#
# SECRETBOX_MASTER_KEY (REQUIRED for multi-tenant FS config) NO va en este YAML.
# Debe exportarse por ENV (base64 de 32 bytes):
#   export SECRETBOX_MASTER_KEY="$(openssl rand -base64 32)"
#
# CONTROL_PLANE_FS_ROOT (opcional, directorio para config FS):
#   export CONTROL_PLANE_FS_ROOT="./data/hellojohn"
#
# MFA (ENV-ONLY):
#   MFA_TOTP_WINDOW=1
#   MFA_TOTP_ISSUER=HelloJohn
#   MFA_REMEMBER_TTL=720h
# Consentimiento (ENV-ONLY, autoconsent básico seguro):
#   CONSENT_AUTO=1                       # 1=autoconsent activo, 0=siempre requerir consentimiento explícito
#   CONSENT_AUTO_SCOPES="openid email profile"  # Scopes que pueden autoconsentirse (subset match)
###############################################

app:
  app_env: "dev"        # dev | staging | prod (en prod se deshabilitan links debug)

server:
  addr: ":8080"
  cors_allowed_origins:
    - "http://localhost:3000"
    - "http://127.0.0.1:5173"

storage:
  driver: "postgres"
  dsn: "postgres://dev_user:dev_pass@localhost:5432/hellojohn?sslmode=disable"
  postgres:
    max_open_conns: 30
    max_idle_conns: 5
    conn_max_lifetime: "30m"
  mysql:
    dsn: "user:pass@tcp(localhost:3306)/hellojohn?parseTime=true&charset=utf8mb4"
  mongo:
    uri: "mongodb://user:pass@localhost:27017"
    database: "hellojohn"

cache:
  kind: "memory"         # memory | redis
  redis:
    addr: "localhost:6379"
    db: 0
    prefix: "hj:"
  memory:
    default_ttl: "2m"    # ENV: CACHE_MEMORY_DEFAULT_TTL (alias soportado: MEMORY_DEFAULT_TTL)

jwt:
  issuer: "http://localhost:8080"
  access_ttl: "15m"
  refresh_ttl: "720h"    # 30 días

register:
  auto_login: true

auth:
  allow_bearer_session: true
  session:
    cookie_name: "sid"
    domain: ""                 # p.ej. .example.com
    samesite: "Lax"            # Lax | Strict | None
    secure: false              # true en prod (HTTPS)
    ttl: "12h"
  # Credenciales básicas para proteger /oauth2/introspect (también se pueden definir por variables de entorno)
  introspect_basic_user: "introspect"
  introspect_basic_pass: "secret"
  reset:
    ttl: "60m"
    auto_login: true
  verify:
    ttl: "48h"

rate:
  enabled: true
  window: "1m"
  max_requests: 60
  # Límites por endpoint (los handlers pueden usar un pool de limiters):
  login:
    limit: 10
    window: "1m"
  forgot:
    limit: 5
    window: "10m"
  mfa:
    enroll:
      limit: 3
      window: "10m"
    verify:
      limit: 10
      window: "1m"
    challenge:
      limit: 10
      window: "1m"
    disable:
      limit: 3
      window: "10m"

flags:
  migrate: true

smtp:
  host: "smtp.example.com"
  port: 587
  username: "no-reply@example.com"   # PLACEHOLDER
  password: "CHANGE_ME_LOCAL_DEV"    # PLACEHOLDER
  from: "no-reply@example.com"
  tls: "starttls"                    # auto | starttls | ssl | none
  insecure_skip_verify: false

email:
  base_url: "http://localhost:8080"
  templates_dir: "./templates"
  debug_echo_links: true             # se fuerza a false si app_env=prod

security:
  # NEW: Master key for encrypting secrets in filesystem config (AES-256-GCM)
  # Must be base64 encoding of 32 bytes. Generate with: openssl rand -base64 32
  # DO NOT SET IN CONFIG FILE - USE ENVIRONMENT VARIABLE INSTEAD:
  # export SECRETBOX_MASTER_KEY="$(openssl rand -base64 32)"
  secretbox_master_key: ""  # Leave empty - set via SECRETBOX_MASTER_KEY env var
  
  password_policy:
    min_length: 10
    require_upper: true
    require_lower: true
    require_digit: true
    require_symbol: false
  # Blacklist opcional de contraseñas débiles conocidas.
  # Cómo usarla:
  #   1. Crear un archivo de texto (una contraseña por línea). Las líneas vacías o que comiencen con '#'
  #      se ignoran. El match es case-insensitive y se recortan espacios laterales.
  #   2. Definir la ruta aquí (relativa al directorio del binario / proyecto) O vía variable de entorno:
  #        SECURITY_PASSWORD_BLACKLIST_PATH=./configs/password_blacklist.txt
  #   3. Reiniciar el servicio. El archivo se carga una única vez al arranque y se cachea en memoria;
  #      si modificas el archivo necesitas reiniciar para que se refleje.
  #   4. Dejar la ruta vacía (o no definir la variable) deshabilita la blacklist.
  # Notas:
  #   - No poner contraseñas reales de usuarios; sólo patrones comunes (ej: password, 123456, qwerty...).
  #   - Para grandes listas considera montar un volumen sólo lectura.
  password_blacklist_path: ""  # vacío = deshabilitada

providers:
  # TTL del code efímero que devuelve /v1/auth/social/result
  login_code_ttl: "60s"
  google:
    enabled: false
    client_id: "YOUR_GOOGLE_OAUTH_CLIENT_ID"
    client_secret: "YOUR_GOOGLE_OAUTH_CLIENT_SECRET"
    redirect_url: ""   # si vacío => <jwt.issuer>/v1/auth/social/google/callback
    scopes: ["openid","email","profile"]
    allowed_tenants: []   # vacío = todos
    allowed_clients: []   # vacío = todos

# NEW: Control Plane Configuration
control_plane:
  # Root directory for filesystem-based configuration storage
  # This will contain tenant config files (YAML) organized by tenant slug
  # Example structure: <fs_root>/tenants/<tenant-slug>/settings.yaml, clients.yaml, etc.
  fs_root: "./data/hellojohn"


###############################################
# Notas producción:
# - CACHE_KIND=redis y config de REDIS_*.
# - Exporta SIGNING_MASTER_KEY (32 bytes).
# - AUTH_SESSION_SECURE=true detrás de HTTPS.
# - EMAIL_DEBUG_LINKS=false en prod (se fuerza por APP_ENV=prod).
# - Health checks en /readyz.
###############################################



