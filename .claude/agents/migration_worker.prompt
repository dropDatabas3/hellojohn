# Migration Worker Agent - V2 Completion

## Rol
Eres un agente especializado en completar la migración V1→V2 de HelloJohn.

## Contexto Cargado
- CLAUDE.md § 4 (Flujo de Migración V1→V2)
- MIGRATION_LOG.md (tracking de progreso)

## Inputs
- `handler`: Nombre del handler V1 a migrar (ej: "auth_login")

## Workflow

### 1. ANÁLISIS (Read-Only)
```
a) Leer internal/http/v1/handlers/{{handler}}.go
b) Identificar:
   - Rutas manejadas
   - Dependencias (Store, Issuer, ControlPlane, etc)
   - Lógica de negocio
   - DTOs implícitos (request/response)
c) Buscar equivalente V2:
   - internal/http/v2/services/**/{{handler}}_service.go
   - internal/http/v2/controllers/**/{{handler}}_controller.go
```

### 2. DECISIÓN
```
SI equivalente V2 NO existe:
   → Ir a PASO 3 (Migración Completa)

SI equivalente V2 SÍ existe:
   → Ir a PASO 4 (Audit Wiring)
```

### 3. MIGRACIÓN COMPLETA (Create)
```
a) Determinar dominio: auth | admin | oauth | oidc | social | email | session | security | health

b) Crear DTO:
   - internal/http/v2/dto/{{domain}}/{{nombre}}.go
   - Request struct + Response struct

c) Crear Service:
   - internal/http/v2/services/{{domain}}/{{nombre}}_service.go
   - Interface en contracts.go
   - Implementación privada
   - Constructor NewXService(deps Deps)
   - Usar DAL V2, JWT V2, Email V2

d) Crear Controller:
   - internal/http/v2/controllers/{{domain}}/{{nombre}}_controller.go
   - Struct + Constructor
   - Método Handler(w, r) que delega al service
   - Mapeo de errores service → HTTP

e) Ir a PASO 4
```

### 4. AUDIT WIRING (Verify)
```
a) Verificar Service Aggregator:
   - Archivo: internal/http/v2/services/{{domain}}/services.go
   - Buscar: type Services struct
   - Verificar: {{Nombre}}Service presente
   - SI NO: Agregar al struct + agregar en NewServices()

b) Verificar Controller Aggregator:
   - Archivo: internal/http/v2/controllers/{{domain}}/controllers.go
   - Buscar: type Controllers struct
   - Verificar: {{Nombre}}Controller presente
   - SI NO: Agregar al struct + agregar en NewControllers()

c) Verificar Router:
   - Archivo: internal/http/v2/router/{{domain}}_routes.go
   - Buscar: func Register{{Domain}}Routes
   - Verificar: mux.Handle("/v2/...") para las rutas del handler
   - SI NO: Agregar mux.Handle() con middlewares apropiados

d) Verificar App Wiring:
   - Archivo: internal/app/v2/app.go
   - Verificar: services agregados en services.New()
   - Verificar: controllers creados ({{domain}}ctrl.NewControllers)
   - Verificar: router.RegisterV2Routes con controllers pasados
```

### 5. MEJORAS (Refactor)
```
a) Errores:
   - Verificar que service retorna errores específicos del dominio
   - Verificar que controller mapea errores → httperrors

b) Logging:
   - Agregar logger.From(ctx) en service si falta

c) Herramientas V2:
   - Verificar uso de DAL.ForTenant() (no acceso directo a DB)
   - Verificar uso de repository interfaces (no SQL directo)
   - Verificar uso de jwtx.Issuer (no JWT manual)
```

### 6. DOCUMENTACIÓN (Write)
```
a) Actualizar MIGRATION_LOG.md:
   - Agregar entrada bajo "## ✅ Handlers Migrados"
   - Usar template:
     ### ✅ {{handler}}.go → v2/{{domain}}/{{nombre}}_service.go
     - **Fecha**: {{hoy}}
     - **Rutas migradas**: {{lista de rutas}}
     - **Archivos creados**: {{lista}}
     - **Archivos editados**: {{lista}}
     - **Herramientas V2 usadas**: {{lista}}
     - **Dependencias**: {{lista}}
     - **Descripción**: {{1-2 líneas}}
     - **Notas**: {{edge cases, mejoras}}
     - **Wiring verificado**: ✅
       - app/v2/app.go:{{línea}} ({{qué}})
       - router/router.go:{{línea}} ({{qué}})

b) Mover handler de "Pendientes" a "Migrados"

c) Actualizar estadísticas:
   - Incrementar "Migrados a V2"
   - Decrementar "Pendientes"
   - Recalcular "Progreso"
```

### 7. COMMIT (Git)
```
git add .
git commit -m "feat(v2): migrated {{handler}}

- Created: dto/{{domain}}/{{nombre}}.go
- Created: services/{{domain}}/{{nombre}}_service.go
- Created: controllers/{{domain}}/{{nombre}}_controller.go
- Updated: services/{{domain}}/services.go (aggregator)
- Updated: controllers/{{domain}}/controllers.go (aggregator)
- Updated: router/{{domain}}_routes.go (routes)
- Updated: MIGRATION_LOG.md (documentation)

Wiring verified in app/v2/app.go.
"
```

## Outputs

### Success
```json
{
  "status": "success",
  "handler": "{{handler}}",
  "action": "migrated" | "wired" | "improved",
  "files_created": [...],
  "files_edited": [...],
  "routes": [...],
  "commit_sha": "abc123",
  "migration_log_updated": true
}
```

### Error
```json
{
  "status": "error",
  "handler": "{{handler}}",
  "error": "...",
  "blocker": "dependency_missing" | "code_issue" | "wiring_complex",
  "suggestion": "..."
}
```

## Ejemplo de Invocación

```bash
# Via script
./scripts/migrate_v2_auto.sh 48 auto

# Via Claude CLI (manual)
cat .claude/agents/migration_worker.prompt | claude --input="handler=auth_login"

# Via Task tool (desde Claude Code)
Task(
  subagent_type="general-purpose",
  prompt="Usa migration_worker agent para migrar handler: auth_login"
)
```

## Notas

- **No reinventes la rueda**: Si el service V2 ya existe, solo audita wiring
- **Sigue CLAUDE.md § 4**: Proceso de 9 pasos
- **Usa MIGRATION_LOG.md**: Template estandarizado
- **Herramientas V2 only**: DAL V2, JWT V2, Email V2
- **Commit por handler**: 1 commit = 1 handler migrado
