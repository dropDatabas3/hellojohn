# ============================================================================
# HelloJohn V2 Environment Configuration
# ============================================================================
# Generated: 2026-01-21
# Purpose: Variables de entorno para arquitectura V2 (servicio independiente)
# Usage: cp .env.v2 .env && edit .env (adjust keys and configs)
# ============================================================================

# --- Entorno ---
APP_ENV=dev  # dev|staging|prod

# ============================================================================
# CRITICAL: Master Keys (REQUIRED)
# ============================================================================
# SIGNING_MASTER_KEY: Para firmar JWT tokens (EdDSA keys) y cifrado MFA
# - Requerido: ≥64 caracteres (hex) o 32 bytes
# - Generar: openssl rand -hex 32
SIGNING_MASTER_KEY=0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef

# SECRETBOX_MASTER_KEY: Para cifrar secretos en Control Plane FS (YAML)
# - Requerido: 32 bytes (base64)
# - Generar: openssl rand -base64 32
SECRETBOX_MASTER_KEY=Z0qYk1Oe7e0rX8NqHkRzL5l1y9Z2Q0E7Vbq3r3b3p0E=

# ============================================================================
# Control Plane (FileSystem)
# ============================================================================
# FS_ROOT: Directorio raíz del Control Plane (tenants, clients, scopes, keys)
FS_ROOT=./data/hellojohn

# CONTROL_PLANE_FS_ROOT: Alias para FS_ROOT (compatibilidad)
CONTROL_PLANE_FS_ROOT=./data/hellojohn

# ============================================================================
# V2 Server Configuration
# ============================================================================
# V2_SERVER_ADDR: Puerto del servidor V2 (diferente de V1 para coexistencia)
V2_SERVER_ADDR=:8080

# V2_BASE_URL: URL base para JWT issuer y email links
V2_BASE_URL=http://localhost:8082

# SERVER_CORS_ALLOWED_ORIGINS: CORS origins permitidos (CSV)
SERVER_CORS_ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000,http://localhost:3001

# ============================================================================
# Data Plane (Tenant Databases)
# ============================================================================
# STORAGE_DRIVER: Driver por defecto para nuevos tenants (postgres|mysql|mongo)
STORAGE_DRIVER=postgres

# STORAGE_DSN: DSN por defecto para pruebas (usado en tenant "local" si no tiene override)
# IMPORTANTE: En producción, cada tenant tiene su propio DSN en tenant.yaml
STORAGE_DSN=postgres://postgres:postgres@localhost:5432/hellojohn?sslmode=disable

# Postgres Connection Pool (default para todos los tenants)
POSTGRES_MAX_OPEN_CONNS=30
POSTGRES_MAX_IDLE_CONNS=10
POSTGRES_CONN_MAX_LIFETIME=30m

# ============================================================================
# Cache & Rate Limiting
# ============================================================================
# CACHE_KIND: memory (default) | redis
CACHE_KIND=memory

# Redis (solo si CACHE_KIND=redis)
# REDIS_ADDR=localhost:6379
# REDIS_DB=0
# REDIS_PREFIX=hj:
# REDIS_PASSWORD=

# Rate Limiting
RATE_ENABLED=true
RATE_WINDOW=1m
RATE_MAX_REQUESTS=60

# Rate Limiting por endpoint (usado por middlewares específicos)
RATE_LOGIN_LIMIT=10
RATE_LOGIN_WINDOW=1m
RATE_FORGOT_LIMIT=5
RATE_FORGOT_WINDOW=10m

# ============================================================================
# JWT Configuration
# ============================================================================
# JWT_ISSUER: Issuer claim en JWT (debe coincidir con V2_BASE_URL)
JWT_ISSUER=http://localhost:8082

# JWT_ACCESS_TTL: TTL de access tokens (short-lived)
JWT_ACCESS_TTL=15m

# JWT_REFRESH_TTL: TTL de refresh tokens (long-lived)
JWT_REFRESH_TTL=720h  # 30 días

# ============================================================================
# Auth & Register Configuration
# ============================================================================
# REGISTER_AUTO_LOGIN: Auto-login tras registro exitoso (emite tokens)
REGISTER_AUTO_LOGIN=true

# AUTH_ALLOW_BEARER_SESSION: Permite usar Bearer token en lugar de cookie
AUTH_ALLOW_BEARER_SESSION=true

# Session Cookie (para OAuth2 Authorization Flow)
AUTH_SESSION_COOKIE_NAME=sid
AUTH_SESSION_DOMAIN=
AUTH_SESSION_SAMESITE=Lax
AUTH_SESSION_SECURE=false  # true en producción con HTTPS
AUTH_SESSION_TTL=12h

# Email Verification & Password Reset TTL
AUTH_VERIFY_TTL=48h
AUTH_RESET_TTL=1h
AUTH_RESET_AUTO_LOGIN=true  # Auto-login tras reset exitoso

# ============================================================================
# MFA (Multi-Factor Authentication)
# ============================================================================
# MFA_TOTP_WINDOW: Ventanas de TOTP aceptadas (±window)
MFA_TOTP_WINDOW=1

# MFA_TOTP_ISSUER: Nombre del issuer en apps TOTP (Google Authenticator, etc)
MFA_TOTP_ISSUER=HelloJohn

# MFA_REMEMBER_TTL: TTL del "remember device" token
MFA_REMEMBER_TTL=720h  # 30 días

# ============================================================================
# SMTP (Email Service)
# ============================================================================
# SMTP_HOST: Servidor SMTP (Gmail, SendGrid, Mailgun, etc)
SMTP_HOST=smtp.gmail.com

# SMTP_PORT: Puerto SMTP (587 para STARTTLS, 465 para SSL)
SMTP_PORT=587

# SMTP_USERNAME: Usuario SMTP
SMTP_USERNAME=tu_usuario@gmail.com

# SMTP_PASSWORD: Password o App Password
SMTP_PASSWORD=tu_password_aqui

# SMTP_FROM: Email "From" en emails enviados
SMTP_FROM=noreply@hellojohn.local

# SMTP_TLS: starttls | ssl | none
SMTP_TLS=starttls

# SMTP_INSECURE_SKIP_VERIFY: Skip TLS verification (solo dev/testing)
SMTP_INSECURE_SKIP_VERIFY=false

# ============================================================================
# Email Templates
# ============================================================================
# EMAIL_BASE_URL: URL base para links en emails (debe coincidir con V2_BASE_URL)
EMAIL_BASE_URL=http://localhost:8082

# EMAIL_TEMPLATES_DIR: Directorio de templates HTML/text
EMAIL_TEMPLATES_DIR=./templates

# EMAIL_DEBUG_LINKS: Mostrar links en logs (dev only, forced false en prod)
EMAIL_DEBUG_LINKS=true

# ============================================================================
# Security (Password Policy)
# ============================================================================
SECURITY_PASSWORD_POLICY_MIN_LENGTH=10
SECURITY_PASSWORD_POLICY_REQUIRE_UPPER=true
SECURITY_PASSWORD_POLICY_REQUIRE_LOWER=true
SECURITY_PASSWORD_POLICY_REQUIRE_DIGIT=true
SECURITY_PASSWORD_POLICY_REQUIRE_SYMBOL=false

# ============================================================================
# Admin & Consent
# ============================================================================
# ADMIN_ENFORCE: Modo estricto (1) o compat (0)
ADMIN_ENFORCE=0

# ADMIN_SUBS: Lista CSV de user_id (UUID) con permisos admin iniciales
# Ejemplo: ADMIN_SUBS=7da4fb61-cb3a-4d7f-a6cd-a9ec4d82440d,abc...
ADMIN_SUBS=

# FS_ADMIN_ENABLE: Permitir crear admins desde FS (sin DB)
FS_ADMIN_ENABLE=false

# CONSENT_AUTO: Auto-consentir scopes first-party (1=sí, 0=modo estricto)
CONSENT_AUTO=1

# CONSENT_AUTO_SCOPES: Scopes auto-consentibles (CSV)
CONSENT_AUTO_SCOPES=openid,email,profile

# ============================================================================
# Social Providers (Google, GitHub, etc)
# ============================================================================
# GOOGLE_ENABLED: Habilitar Google OAuth
GOOGLE_ENABLED=false

# GOOGLE_CLIENT_ID: OAuth Client ID de Google
GOOGLE_CLIENT_ID=

# GOOGLE_CLIENT_SECRET: OAuth Client Secret de Google
GOOGLE_CLIENT_SECRET=

# GOOGLE_REDIRECT_URL: Redirect URI configurado en Google Console
GOOGLE_REDIRECT_URL=http://localhost:8082/v2/auth/social/google/callback

# GOOGLE_SCOPES: Scopes solicitados (CSV)
GOOGLE_SCOPES=openid,email,profile

# GOOGLE_ALLOWED_TENANTS: Limitar provider a tenants específicos (CSV, vacío=todos)
GOOGLE_ALLOWED_TENANTS=

# GOOGLE_ALLOWED_CLIENTS: Limitar provider a clients específicos (CSV, vacío=todos)
GOOGLE_ALLOWED_CLIENTS=

# Social Login Code TTL (código temporal devuelto por /social/result)
SOCIAL_LOGIN_CODE_TTL=60s

# SOCIAL_DEBUG_PEEK: Permitir /v2/auth/social/debug-peek (dev only)
SOCIAL_DEBUG_PEEK=false

# ============================================================================
# Cluster / Raft (Multi-nodo HA)
# ============================================================================
# CLUSTER_MODE: off (default) | embedded
# - off: Single-nodo
# - embedded: Multi-nodo con Raft consensus
CLUSTER_MODE=off

# NODE_ID: Identificador único del nodo en el cluster
# NODE_ID=node-1

# RAFT_ADDR: Dirección de bind para Raft (host:port)
# RAFT_ADDR=0.0.0.0:7000

# CLUSTER_NODES: Lista de nodos (nodeID=host:port;nodeID=host:port)
# CLUSTER_NODES=node-1=localhost:7000;node-2=localhost:7001;node-3=localhost:7002

# LEADER_REDIRECTS: Lista de redirects HTTP (nodeID=http://host:port)
# LEADER_REDIRECTS=node-1=http://localhost:8082;node-2=http://localhost:8083;node-3=http://localhost:8084

# RAFT_SNAPSHOT_EVERY: Frecuencia de snapshot (número de entradas)
# RAFT_SNAPSHOT_EVERY=1000

# RAFT_MAX_LOG_MB: Límite de tamaño de log antes de snapshot (MB)
# RAFT_MAX_LOG_MB=100

# ============================================================================
# Raft TLS (Opcional: mTLS para comunicación Raft)
# ============================================================================
# RAFT_TLS_ENABLE=true
# RAFT_TLS_CERT_FILE=./certs/node1.crt
# RAFT_TLS_KEY_FILE=./certs/node1.key
# RAFT_TLS_CA_FILE=./certs/ca.crt
# RAFT_TLS_SERVER_NAME=localhost

# ============================================================================
# Migrations & Flags
# ============================================================================
# FLAGS_MIGRATE: Auto-migrar tenants al arrancar (dev only)
FLAGS_MIGRATE=false

# ============================================================================
# Seed Data (cmd/seed - opcional para testing)
# ============================================================================
# SEED_TENANT_SLUG=local
# SEED_TENANT_NAME=Local Tenant
# SEED_ADMIN_EMAIL=admin@local.test
# SEED_ADMIN_PASSWORD=SuperS3creta!
# SEED_CLIENT_ID=web-frontend
# SEED_CLIENT_NAME=Web Frontend
# SEED_CLIENT_TYPE=public
# SEED_REDIRECT_URIS=http://localhost:3000/callback
# SEED_PROVIDERS=password,google
# SEED_SCOPES=openid,email,profile,offline_access

# ============================================================================
# Testing & Development
# ============================================================================
# DISABLE_DOTENV: Deshabilitar carga de .env (usado por tests)
# DISABLE_DOTENV=1

# ============================================================================
# FIN DE CONFIGURACIÓN V2
# ============================================================================
