# Claude Context Configuration for HelloJohn V2

## Context Strategy: Modular + Lazy Loading

### Primary Documents (Always Load)
- `CLAUDE.md` - Architecture reference (68KB, ~1900 lines)
- `MIGRATION_LOG.md` - Migration tracking (active)

### Secondary Documents (Load on Demand)
- `docs/v2-toolbox.md` - When working on specific V2 tools
- `docs/refactor_docs/V1_HANDLERS_INVENTORY.md` - When migrating handlers
- `internal/store/v2/README.md` - When working with DAL
- `internal/controlplane/v2/README.md` - When working with Control Plane

## Token Budget Strategy

### Current Usage
- `CLAUDE.md`: ~68KB → ~17,000 tokens (estimation: 4 chars/token)
- `MIGRATION_LOG.md`: ~6KB → ~1,500 tokens
- **Total context**: ~18,500 tokens
- **Budget remaining**: ~181,500 tokens (out of 200K)

### Optimization Rules

1. **Don't load entire CLAUDE.md every time**
   - Use section references: "See CLAUDE.md § 5.1 (Service Pattern)"
   - Only read specific sections when needed

2. **Use MIGRATION_LOG.md as index**
   - Check what's migrated before reading V1 handlers
   - Avoid re-migrating completed handlers

3. **Read V1 handlers incrementally**
   - Only load the specific handler being migrated
   - Don't load all 48 handlers at once

4. **Context compression**
   - After migration, summarize in MIGRATION_LOG.md
   - Don't need to re-read migrated handlers

### Workflow Optimization

#### ❌ INEFFICIENT (High token usage)
```
1. Load CLAUDE.md (17K tokens)
2. Load V1_HANDLERS_INVENTORY.md (10K tokens)
3. Load all V1 handlers (50K+ tokens)
4. Migrate one handler
Total: 77K+ tokens for ONE migration
```

#### ✅ EFFICIENT (Low token usage)
```
1. Load MIGRATION_LOG.md (1.5K tokens)
2. Identify next handler to migrate
3. Load ONLY that V1 handler (1K tokens)
4. Reference CLAUDE.md § 4 (Flujo de Migración) - 2K tokens
5. Migrate handler
6. Update MIGRATION_LOG.md
Total: ~5K tokens per migration
```

### Section-Based Loading

When Claude needs help, load ONLY relevant sections:

| Task | Load Section | Token Cost |
|------|-------------|------------|
| Understand architecture | CLAUDE.md § 2 | ~3K |
| Migrate handler | CLAUDE.md § 4 | ~4K |
| Implement service | CLAUDE.md § 5.1 | ~2K |
| Use DAL | CLAUDE.md § 6 | ~3K |
| Configure Raft | CLAUDE.md § 7 | ~2K |

### Incremental Updates

Instead of re-generating entire CLAUDE.md:

1. Make targeted edits using Edit tool
2. Add new sections only when needed
3. Keep MIGRATION_LOG.md as lightweight index

## File Size Targets

- `CLAUDE.md`: Keep under 100KB (currently 68KB ✅)
- `MIGRATION_LOG.md`: Grow naturally (currently 6KB ✅)
- Per-section in CLAUDE.md: Target 5-10KB each

## Review Schedule

- **Weekly**: Check if CLAUDE.md sections need consolidation
- **Per migration**: Update MIGRATION_LOG.md immediately
- **Monthly**: Archive old migration notes if needed

---

**Conclusion**: The current structure is **token-efficient** if used correctly.
The key is **lazy loading** sections, not loading everything at once.
